# テストシナリオ (通信不良・異常系中心)

## 前提
- 対象: TORIHandyFrontend
- 目的: Wi-Fi不調時のリカバリー、異常系対応の確認
- 端末: ハンディ端末 (BHT-M60 想定)
- バックエンド: /api/Products/delivery と /api/health を提供

## シナリオ一覧

### 1. 通信断 → バッファ保存 → 復旧後再送（完了）
- 条件
  - Wi-Fiをオフにする、またはサーバー到達不可
- 手順
  1. 商品ID/数量/個体識別IDを入力し送信
  2. 送信失敗メッセージを確認
  3. 未送信データ画面で未送信件数を確認
  4. Wi-Fiを復旧
  5. 5秒以内に再送が始まり、バッファが減ることを確認
- 期待結果
  - 送信失敗時にバッファへ保存
  - 復旧後に自動再送され、バッファが空になる

### 2. 起動時に未送信データがある場合の安定性
- 条件
  - 端末内に未送信データが存在
- 手順
  1. 通信断状態で送信してバッファを作成
  2. アプリを強制終了
  3. アプリ再起動
- 期待結果
  - クラッシュしない
  - バッファ内容が保持される

### 3. サーバー健全性チェック失敗時の挙動
- 条件
  - /api/health が 500 を返す、またはタイムアウト
- 手順
  1. バッファに未送信データを用意
  2. /api/health を失敗させる
- 期待結果
  - 再送処理は開始されない
  - バッファが保持される

### 4. 送信APIが 200/204 の正常応答
- 条件
  - /api/Products/delivery が 200/204 を返す
- 手順
  1. 送信実行
- 期待結果
  - 成功メッセージが表示される
  - 送信履歴に成功が記録される
  - バッファに保存されない

### 5. 送信APIが 400/403/404 を返す
- 条件
  - /api/Products/delivery が 400/403/404 を返す
- 手順
  1. 送信実行
- 期待結果
  - エラーメッセージが表示される
  - 400/403/404: バッファに保存されない
  - 送信履歴に失敗が記録される

### 6. 送信APIが 500/502 などの異常応答
- 条件
  - /api/Products/delivery が 500/502 を返す
- 手順
  1. 送信実行
- 期待結果
  - エラーメッセージが表示される
  - バッファに保存される

### 7. 入力: 商品IDが 9 で始まらない
- 手順
  1. 商品ID欄で「9」以外で始まるコードを入力
- 期待結果
  - エラーメッセージ表示
  - 入力は受け付けない

### 7.1 入力: 商品IDの桁数不正
- 手順
  1. 商品ID欄で 11桁の数値を入力
  2. 商品ID欄で 14桁以上の数値を入力
- 期待結果
  - エラーメッセージ表示
  - 入力は受け付けない

### 7.2 入力: 商品IDが13桁（先頭9）
- 手順
  1. 商品ID欄で先頭9の13桁数値を入力
- 期待結果
  - 先頭1文字が削除され、12桁で採用される

### 8. 入力: 数量手入力で小数点なし
- 手順
  1. 数量欄で `1` のように小数点無しで入力
  2. フォーカスを外す
- 期待結果
  - エラーメッセージ表示
  - 入力欄に再フォーカス

### 8.1 入力: 数量手入力で先頭ドット
- 手順
  1. 数量欄で `.123` のように先頭ドットで入力
  2. フォーカスを外す
- 期待結果
  - `0.123` として採用される

### 9. 入力: 数量欄で商品IDバーコードをスキャン
- 手順
  1. 数量欄がフォーカスされた状態で商品IDバーコードをスキャン
- 期待結果
  - 商品ID欄へ自動格納される
  - 数量欄の値は復元される

### 10. 個体識別ID抽出
- 手順
  1. 10桁数字のみのバーコードを入力
  2. `251` で始まり10桁が続くバーコードを入力
  3. どちらにも該当しない文字列を入力
- 期待結果
  - 1: 10桁がそのまま採用
  - 2: `251` 直後の10桁が採用（後続が長くても可）
  - 3: エラーメッセージ表示、個体識別IDは未入力扱い

### 10.1 数量の桁数上限
- 手順
  1. 数量欄に小数点を含む12桁超の値を入力
  2. フォーカスを外す
- 期待結果
  - 「数量は12桁以内です。」が表示される

### 11. 連続スキャン時の入力消失 (不具合再現)
- 条件
  - 高速スキャンを実施
- 手順
  1. 商品ID→数量→個体識別IDを連続スキャン
  2. 個体識別IDが一瞬表示された後消えるか確認
- 期待結果
  - 消失しないこと
  - 消失する場合はログを確認

### 12. キーイベント消費と入力欠落の確認
- 条件
  - ハードウェアキー入力が KeyEvent として飛ぶ環境
- 手順
  1. 数字キーの連打またはスキャン入力
  2. 入力欄の値が欠落しないか確認
- 期待結果
  - 入力欠落が起きない

### 12.1 Enter送信（フォーカス不問）
- 手順
  1. 商品IDと数量が入った状態で Enter を押す
- 期待結果
  - 送信される

### 12.2 F4送信（フォーカス不問）
- 手順
  1. 商品IDと数量が入った状態で F4 を押す
- 期待結果
  - 送信される

### 13. 送信APIが200でもsuccess=false（業務エラー）
- 条件
  - /api/Products/delivery が 200 を返すが body の success が false
- 手順
  1. 送信実行
- 期待結果
  - エラーメッセージが表示される
  - バッファに保存されない
  - 送信履歴に失敗が記録される

## 補足
- 不具合調査用にログ追加を行う場合は、
  フォーカス取得/喪失と `onValueChange` の順序が追えるようにする。
