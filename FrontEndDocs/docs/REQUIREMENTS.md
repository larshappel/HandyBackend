# 要件定義 (暫定)

## 1. 目的
- ハンディスキャナでバーコードを読み取り、納品データをサーバーへ送信する。
- 通信不良時でもデータ消失を防ぎ、復旧後に自動再送する。

## 2. 対象ユーザー/環境
- 工場内の作業者
- ハンディ端末 (Denso BHT-M60 想定)
- Android 7.0+ (minSdk 24)
- Wi-Fi環境が不安定なエリアを含む

## 3. 業務データ
- 商品ID (Product ID)
- 個体識別ID (Individual ID)
- 数量 (Amount)

## 4. 機能要件

### 4.1 入力/スキャン
- スキャンは順不同で受け付け、自動判定して該当フィールドに格納する
- 商品ID
  - 数値のみ
  - 12桁固定（先頭`9`）
  - 13桁で先頭が `9` の場合は先頭1文字を削除して12桁化
  - 上記以外（11桁以下/14桁以上/先頭が9でない）はエラー
- 個体識別ID
  - 10桁数字のみならそのまま採用
  - `251` で始まる場合は「`251` の直後10桁」を抽出（後続が長くても可）
  - 該当しない場合は空文字 (未入力扱い)
  - 数値以外は判定時に無視
- 数量
  - バーコードスキャンまたは手入力に対応
  - 手入力時は小数点必須（先頭ドットは `0.x` として許容）
  - 小数点を除いた桁数は12桁以内
  - 判定ルールに合わない場合はエラー
  - 数値のみ
  - 単位は g とし、入力後に kg へ変換
  - 先頭5桁が `00000` の場合は数量バーコードと判定する
- 連続スキャン
  - 0.5秒間隔でも入力消失が起きないこと

### 4.1.2 キー操作（送信）
- F1: 商品IDにフォーカス移動
- F2: 数量にフォーカス移動
- F3: 個体識別IDにフォーカス移動
- Enter/F4: 商品IDと数量が入っていれば送信する（個体識別IDが入っていても送信・フォーカス不問）
- Enter/F4: 送信ボタンが灰色（必須不足）のときは送信されない

### 4.1.1 バーコード判定ルール (自動振り分け)
- 商品ID: 12桁の数値コード（先頭`9`）、または13桁で先頭`9`のみ先頭1文字を削除
- 数量: 先頭5桁が `00000` の数値コード (単位は g)
- 個体識別ID: 10桁の数値コード、または `251` + 10桁の数値コード
- スキャン順序は順不同
- 判定できない場合はエラー表示

### 4.2 送信
- 送信エンドポイント: `POST api/Products/delivery`
- ベースURL: `http://<server-ip>:<port>/`（未入力時は5000）
- 送信データは JSON 形式で送信する
- 送信データに端末IDを含める
- 送信データに送信日時を含める
- 4xx 応答の扱い
  - 400/403/404: 恒久エラーとしてバッファせずに破棄

### 4.3 オフライン対応
- 通信失敗時は端末内に未送信データとして保存
- 復旧後に自動再送 (5秒間隔)

### 4.4 設定
- サーバーIPアドレスの変更が可能
- ポートの変更が可能（未入力時は5000）
- 端末IDは設定画面で手入力する
- 設定画面表示中のみ、5秒ごとに疎通確認を行い接続状態を表示する
  - 表示: `サーバ設定(接続済/未接続/確認中)`（括弧内だけ色を変える）

### 4.5 送信履歴
- 送信結果を画面で確認できる
- 送信履歴は端末内に永続化する
- 最大200件まで保持する

## 5. 非機能要件

### 5.1 信頼性
- Wi-Fi不調時でもデータ消失しないこと
- 0.5秒間隔の連続スキャンでも安定動作

### 5.2 性能
- スキャンから送信までの処理が作業を妨げない速度であること

### 5.3 保守性
- ログによる調査が可能なこと

## 6. 例外/エラーハンドリング
- 商品ID不正時はエラー表示
- 数量手入力の小数点欠如はエラー表示
- 通信エラー時はバッファ保存し、ユーザーに通知

## 7. バックエンド連携
- 送信されたデータはバックエンドでMySQLへ保存
- 同時アクセス時の整合性はDBトランザクションで担保

## 8. 未確定事項 (要確認)
- 二重送信防止の方針 (UI側/サーバー側)
