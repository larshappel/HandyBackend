ドキュメント一覧
- `Readme.md`: プロジェクト概要、仕様、ビルド/実行手順のまとめ
- `docs/REQUIREMENTS.md`: 要件定義と運用前提
- `docs/UI.md`: 画面/入力/ボタン状態のUI仕様
- `docs/DELIVERY_API.md`: 送信APIの仕様と懸念点
- `docs/LOG.md`: ログ出力の一覧と削除方針
- `docs/REVIEW.md`: 送信/リカバリー周りのレビュー記録
- `docs/RECEIVER_UI.md`: 受信データ確認UIの使い方
- `docs/RECEIVER_UI_PLAN.md`: 受信UIの計画/設計メモ
- `docs/TEST.md`: テストシナリオ（異常系中心）
- `docs/PROGRESS.md`: 作業進捗の記録
- `docs/FOR_CODEX.md`: Codex用の運用ルール
- `docs/PGDESIGN.md`: 詳細設計書
- `docs/HISTORY.md`: 変更履歴
- `docs/REPORT.md`: 調査/報告メモ
- `docs/Consideration.md`: 仕様検討メモ
- `docs/Test_Scenarios.md`: 補足テストシナリオ

## リリースノート

### v1.0.42
- 設定画面に「サーバ設定(接続済/未接続/確認中)」を表示（5秒間隔で疎通確認）
- Enter/F4で送信可能（商品ID+数量が入っている場合、フォーカス不問）

プロジェクト概要
- ハンディ端末でバーコードを読み取り、納品データをサーバーへ送信するAndroidアプリ。
- 通信不良時は端末内に保存し、復旧後に自動再送する。
- 対象端末: Denso BHT-M60 (想定)、Android 7.0+ (minSdk 24)

主要構成
- UI: Jetpack Compose (`app/src/main/java/com/example/handytestapp/ui/screens`)
- ロジック: `DeliveryViewModel` が入力判定/送信/バッファ/再送を担当
- 保存: Room (未送信データの永続化)
- 設定: DataStore (サーバーIP/端末ID)
- 通信: Retrofit/OkHttp (`/api/Products/delivery`, `/api/health`)

画面一覧
- 納品登録（メイン）
- 未送信データ（未送信データ一覧）
- 送信履歴（最大200件、再起動後も保持）
- 設定（サーバーIP/端末ID、**3回タップで開く**）

入力/スキャン判定（実装ベース）
- 商品ID: 数値のみ、12桁固定（先頭9）。13桁で先頭9なら先頭1文字を削除して12桁化
- 数量: 小数入力可（数値+1つの小数点、先頭ドットは0.x扱い、**小数点を除いて12桁以内**）/ 数量バーコードは先頭5桁`00000`でg→kg変換
- 個体識別: 10桁数字、または`251`+10桁（先頭一致）から抽出
- 不正な形式はエラーメッセージ表示

送信/バッファ/再送（実装ベース）
- 送信成功: 送信履歴に追加
- 送信失敗(5xx/通信失敗): Roomに保存し未送信件数を表示
- 自動再送: アプリ起動中に5秒間隔で`/api/health`チェック後再送
- 4xxの扱い: 400/403/404は破棄

設定
- サーバーIP/端末IDはDataStoreで保存
- 初期IPは`192.168.10.247`（`ServerSettingsRepository`のDEFAULT_IP）

ログ
- 端末ログは`/sdcard/Android/data/<package>/files/logs/`へ保存
- デバッグビルド時は画面下にステータス表示

ビルド/実行
- Debugビルド: `./gradlew assembleDebug`
- 実機インストール: `./gradlew installDebug`
- Unitテスト: `./gradlew testDebugUnitTest`
- Debugアプリは`applicationIdSuffix = ".dev"`で別インストール
- Releaseビルド: `./gradlew assembleRelease`

リリース署名（keystore.propertiesの配布）
- 署名用 keystore は `keystore/toriyasu-release.jks` を使用する
- 署名情報は `keystore.properties` で参照する（Git管理外）
- 配布方法:
  1) 管理者から `keystore/toriyasu-release.jks` と `keystore.properties` を受け取る
  2) プロジェクト直下に配置する
     - `./keystore/toriyasu-release.jks`
     - `./keystore.properties`

API仕様（実装ベース）
- Base URL: `http://<server_ip>:<port>/`（ポート未入力時は5000）
- POST `api/Products/delivery`
  - body: `individual_id`, `product_id`, `amount`, `terminal_id`, `sent_at`
  - response: `{ success: Boolean, message: String }`
- GET `api/health`

データ永続化（実装ベース）
- 未送信データ: Roomテーブル `delivery_records`
- 送信履歴: Roomテーブル `send_history`
- 未送信カラム: `id`(自動採番), `individual_id`, `product_id`, `amount`
- 送信履歴カラム: `id`, `timestamp`, `individual_id`, `product_id`, `amount`, `success`, `message`
- マイグレーション: `MIGRATION_1_2`, `MIGRATION_2_3`（非破壊）

要件定義 (暫定)
1. 目的
ハンディスキャナでバーコードを読み取り、納品データをサーバーへ送信する。
通信不良時でもデータ消失を防ぎ、復旧後に自動再送する。
2. 対象ユーザー/環境
工場内の作業者
ハンディ端末 (Denso BHT-M60 想定)
Android 7.0+ (minSdk 24)
Wi-Fi環境が不安定なエリアを含む
3. 納品データ
商品ID (Product ID)
個体識別番号 (Individual ID)
数量 (Amount)
4. 機能要件
4.1 入力/スキャン
	共通動作　バーコード読み込み時は上書きする

商品ID（数値のみ）商品IDのバーコードスキャン及び入力（必須入力）
空白は許容するが送信不可（未入力扱い）
数値のみ
12桁固定（先頭9）
13桁で先頭が 9 の場合は先頭1文字（9）を削除して12桁化
上記以外（11桁以下/14桁以上/先頭が9でない）は商品IDとしてはエラー

数量（Ｋｇ）（数値のみ）（必須入力）
バーコードスキャンまたは手入力に対応
スキャンの場合：数量バーコードはｇ数のためｇ数を自動でＫｇに変換
手入力時：Ｋｇ数を入力。小数点の入力が必須
小数点の入力がない場合はエラーメッセージを表示
先頭ドット入力は `0.x` として扱う
先頭5桁が `00000` でない場合は「数量バーコードではありません」を表示
数値のみ
単位は g とし、入力後に Kg へ変換
先頭5桁が `00000` の数値コードを数量バーコードと判定する

個体識別番号（数値のみ）個体識別番号のバーコードスキャン及び入力（省略可）
10桁数字のみならそのまま採用
`251` で始まり10桁が続く場合は、`251` の直後10桁を抽出（後続が長くても可）
251XXXXXXXXXX...
上記２パターンに当てはまらない場合はエラーメッセージを表示
スキャンしない場合は空文字 (未入力)
数値のみ
高速スキャン
0.5秒間隔でスキャンしても正常にバーコードを読み取りデータの書き込みが完了する
4.2 送信
サーバーにwifi経由で納品データを送信する
納品データに加えハンディの端末IDと送信日時を送信する
同じ商品IDを何度も送信することは可能
4.3 オフライン対応
通信失敗時は端末内に未送信データを保存
納品登録画面に未送信データの件数が表示される
アプリまたは電源を落としても未送信データはクリアされない
wifi復旧後に自動再送 (5秒間隔)※アプリ起動時に限る
4.4 設定
送信先のサーバーIPアドレスの変更が可能
ハンディの端末IDの設定が可能、重複チェックはしない
4.5 送信履歴
送信結果を画面で確認できる
送信履歴の最大件数は200件
送信履歴は端末内に永続化する
5. 非機能要件
5.1 信頼性
Wi-Fi不調時でもデータ消失しないこと
0.5秒間隔の高速スキャンでも安定動作
5.2 性能
スキャンから送信までの処理が作業を妨げない速度であること
5.3 保守性
ログによる調査が可能なこと
6. 例外/エラーハンドリング
商品ID不正時はエラー表示
数量手入力の小数点欠如はエラー表示
通信エラー時はバッファ保存し、ユーザーに通知
7. バックエンド連携
送信されたデータはバックエンドでデータベースへ保存
同時アクセス時の整合性はデータベーストランザクションで担保
大量の未送信データを送信しても正常にデータベースに書き込みできること
1分以内でデータベースに100件書き込むこと
※サーバーが他のプロセスで占領されていない場合に限る

8. 注意喚起（イレギュラー）
- バーコードが数値以外を含む場合は分類できないためエラー表示になる
- どのルールにも当てはまらないバーコードは「分類不能」としてエラー表示になる
- 数量バーコードは先頭5桁が0でない場合は「数量バーコードではありません」を表示する
- 商品IDは12桁固定（先頭9）。13桁で先頭9のみ先頭1文字を削除して12桁化する
- 10桁数値は個体識別として判定される
