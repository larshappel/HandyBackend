# Handy Backend 要件定義書（受信側）

## 1. 目的
- ハンディスキャナから送られてくる納品情報（商品識別コード、数量、端末・担当者情報）をサーバーが確実に受信し、データベースと監査ログに記録する。
- 通信が不安定な現場でも送信したデータを失わず、通信回復時に自動再送できるようにして業務に支障が出ないようにする。
- 本番の Windows 環境と同じ DB 構造を維持しながら、開発者／検証者がローカルで挙動を確認できる形にする。

## 2. 対象ユーザー／システム環境
- 工場や物流センターなどでバーコードを読み取る作業者。
- Denso BHT-M60 など Android 7.0 以上のハンディ端末を想定。
- Wi-Fi が途切れやすい現場でも、ローカルおよびサーバー側で再送・再処理可能な仕組みを前提とする。
- 本番運用は Windows サーバー＋MySQL で、ローカル検証環境では macOS や Windows 上に同じ構造の DB（例：SHIRAKIPR）を用意してテストする。

## 3. 機能要件
### 3-1. 受信リクエスト処理
- ハンディ端末から受信するデータは `product_id`（バーコード文字列）、`amount`（積み増し数量）、`individual_id`（端末固有ID）、`device_id`（端末名）の構成で、`product_id` の形式チェック後、該当する商品レコードにアクセスして数量やスキャン回数を更新する。
- 該当商品が存在しない、または `product_id` が整数にならない場合はエラーとしてクライアントへ通知し、再送を促す。通信再開時の再送に備えてリクエストの冪等性を意識し、スキャン済み（スキャン回数が発行数を超える）なら同じリクエストを重複処理しない。
- 更新対象が存在する場合は既存数量へ受信数量を加算し、スキャン回数をカウントアップし、識別番号や更新日時を記録する。更新後はクライアントに成功メッセージを返し、ログにも記録することであとから確認できるようにする。

### 3-2. ログ・監査（ログを使って「送った/送ってない」を調べる）
- ハンディ端末から届いたデータは、すべて CSV のログに書き出す。ログの 1 行は「いつ」「どのバーコード」「何個」「どの端末」「結果」になっている。たとえば「2026-01-28 17:25:39」「900100000357」「0.45」「端末A」「商品情報がない」であれば、Magic XPA 側で表示しない理由が「商品コードが登録されていない」とわかる。このようにログを見れば、「送ったけど処理できなかった」のか「処理済みだから表示の問題なのか」「そもそも送信されていないのか」を順番にたどることができる。
- 結果の列には、「更新に成功」「商品が見つからない」「同じものを何度も送っている（スキャン済み）」などの言葉を使い、見ればすぐに何が起きたかがわかるようにする。ログは日ごとに分けて保存し、問題が発生した日時のファイルだけを直接開いて確認する。
- サーバーでのエラーや例外も別のログファイルに記録し、「なぜ処理できなかったか」を追いやすくする。UI はこのログを自動表示しないので、調査するときはファイルを直接読む運用とする。

### 3-3. データの整合性
- サーバーは商品情報テーブルに記録があるか確認し、照合できた記録だけを更新する。該当情報が存在していなければエラーを返すことで、Magic XPA 上の表示とズレが出ないようにする。
- 更新対象が見つかった場合、数量とスキャン回数を加算し、担当者情報や更新日時を記録してデータの信頼性を保つ。これにより、表示されない商品があるという問い合わせに対して「データベース側ではこう処理した」という根拠を提示できるようにする。
- 本番展開では現行のデータベース構造とズレが出ないよう、まずバックアップを取得してから変更を適用し、必要なら元に戻せる手順を準備することで一貫性を確保する。

## 4. 非機能要件（仮置き）
- 可用性：通信が不安定でも一定時間に数十件のリクエストを捌けるようにし、リトライによる重複送信でもデータ破壊が発生しない。
- 性能：1 秒あたり十数件の配送ログを EF Core で処理してもタイムアウトしないよう、データベースアクセスのトランザクションは必要最小限にする。
- 運用性：ログディレクトリにアクセス権を与えて圧縮／バックアップできるようにし、`TESTUI.md`／`docs/TEST_DATABASE.md` などの手順書で運用手順を明文化する。
- セキュリティ：開発環境では認証を省略するが、本番では Windows サービスの起動・ポート制限・ファイアウォールによるアクセス制御を継続する。

## 5. 実装しないこと（スコープ外）
- ハンディ端末側の再送ロジックや UI はこの文書の範囲外。
- `/check` などのテスト UI は簡易表示に限定し、ログの自動表示や複雑なデータ編集機能は含めない。以上は別途ドキュメント/ツールで対応する。
- 本番環境の OS／サービス構成を変更しない。サーバーは現行の Windows + MySQL の構成を前提とする。
